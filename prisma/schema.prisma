generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id String @id @default(uuid())
  logo String?
  name  String
  email String @unique
  address String
  contactNumber String
  contactPerson String
  gst String?
  accountLimit  Int @default(5)
  settingCodeEncrypted String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  visits Visit[]
  staff Staff[]
  authCredentials UserCredential[]
  systemCredentials SystemCredential[]
  departments Department[]
  reasonOfVisits  ReasonOfVisit[]
   attendanceSessions AttendanceSession[]
  attendanceEvents AttendanceEvent[]
  teams Team[]
 subscription Subscription?
 featureUsages FeatureUsage[]
 notifications Notification[]
}

model Visit {
  id  String @id @default(uuid())
  orgId   String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  fullName  String
  visitorOrganization  String
  email  String
  reasonId  String?
  reasonOfVisit ReasonOfVisit? @relation(fields: [reasonId], references: [id])
  staffId String
  staff Staff @relation(fields: [staffId], references: [id], onDelete: Cascade)
  startTime DateTime? 
  endTime DateTime?
  status  MeetingStatus @default(PENDING)
  checkInPicture  String? 
  remarks  String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt  
  notifications Notification[]
}

model Staff {
  id String @id @default(uuid())
  orgId String
  organization  Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  userId String?  @unique
  userCredential UserCredential? @relation("StaffAuth", fields: [userId], references: [id], onDelete: Cascade)
  name  String  
  email String  @unique
  designation String 
  departmentId  String?  
  department  Department?  @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  role MemberRoleEnum @default(Staff)

  employeeCode String? @unique // used in QR / manual entry
  badgeActive  Boolean @default(true)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  visits Visit[]
  attendanceSessions AttendanceSession[]
  attendanceEvents AttendanceEvent[]
  teamMemberships   TeamMember[]         @relation("TeamMemberStaff")
  reportsTo         TeamReporting[]      @relation("Reportee")
  manages           TeamReporting[]      @relation("Manager")
  masterOfTeams     Team[]               @relation("MasterManager")
  notifications Notification[]
  
}

model AttendanceSession {
  id       String   @id @default(uuid())
  orgId    String
  staffId  String
  //usually startOfDay of first punch-in
  date     DateTime
  status       AttendanceSessionStatus @default(OPEN)
  closureType  AttendanceClosureType?
  isLateClosure          Boolean   @default(false)
  latePunchOutReason     String?
  latePunchOutRecordedAt DateTime?
  firstPunchInAt   DateTime?
  lastPunchOutAt   DateTime?
  totalWorkSeconds  Int @default(0)
  totalBreakSeconds Int @default(0)
  events   AttendanceEvent[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  staff        Staff        @relation(fields: [staffId], references: [id], onDelete: Cascade)
}

model AttendanceEvent {
  id      String  @id @default(uuid())
  orgId   String
  staffId String
  sessionId String?
  eventType AttendanceEventType
  source    AttendanceEventSource @default(QR)
  timestamp DateTime @default(now())
  // for corrections / late punches
  isCorrection   Boolean @default(false)
  correctionNote String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  staff        Staff        @relation(fields: [staffId], references: [id], onDelete: Cascade)
  session      AttendanceSession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)
}

enum AttendanceEventType {
  PUNCH_IN
  PUNCH_OUT
  BREAK_START
  BREAK_END
  LATE_PUNCH_OUT
}

enum AttendanceSessionStatus {
  OPEN
  CLOSED
}

enum AttendanceClosureType {
  NORMAL
  LATE
}

enum AttendanceEventSource {
  QR
  EMPLOYEE_ID
}


model RefreshToken {
  id  String @id @default(uuid())
  token String @unique
  userId  String?
  userCredentials UserCredential? @relation(fields: [userId], references: [id], onDelete: Cascade)
  systemId  String?
  systemCredentials SystemCredential? @relation(fields: [systemId], references: [id], onDelete: Cascade)
  expiryDate  DateTime
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}


model UserCredential{
  id String @id @default(uuid())
  orgId String?
  organization  Organization? @relation(fields: [orgId],references: [id], onDelete: Cascade)
  email String @unique
  password  String
  role AuthRoleEnum
  firstTimeLogin  Boolean? @default(true)
  accountStatus   AccountStatusEnum @default(Active) 
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  staff    Staff?  @relation("StaffAuth")
  refreshToken RefreshToken[]
  resetToken  ResetToken[]
}

model SystemCredential {
  id String @id @default(uuid())
  orgId String
  organization  Organization @relation(fields: [orgId],references: [id], onDelete: Cascade)
  email String @unique
  password  String
  secretCode  String?
  activityStatus  LoginStatus @default(LoggedOut)
  sessionId String?
  role String @default("System")
  refreshToken  RefreshToken[]
  resetTokenSystem  ResetTokenSystem[]
}

model Department {
  id  String  @id @default(uuid())
  orgId String
  organization  Organization  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  name  String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  staffs Staff[]
}

model ReasonOfVisit {
  id  String  @id @default(uuid())
  orgId String
  organization  Organization  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  name  String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  vists Visit[]
}

model ResetToken {
  id String @id @default(uuid())
  token String @unique
  userId  String @unique
  userCredential  UserCredential  @relation(fields: [userId],  references: [id], onDelete: Cascade)
  
}

model ResetTokenSystem {
    id String @id @default(uuid())
  token String @unique
  systemId String @unique
  systemCredential SystemCredential @relation(fields: [systemId], references: [id], onDelete: Cascade)
}


enum MeetingStatus {
  ONGOING
  COMPLETED
  PENDING
  REJECTED
  ACCEPTED
}

enum AuthRoleEnum {
  Root
  SuperAdmin
  Admin
  Staff
}

enum MemberRoleEnum {
  SuperAdmin
  Admin
  Staff
}

enum AccountStatusEnum {
  Active
  Disabled
}

enum LoginStatus {
  LoggedIn
  LoggedOut
}

model Team {
  id        String   @id @default(uuid())
  orgId     String
  name      String

  // master manager of the team
  masterManagerId String
  masterManager   Staff     @relation("MasterManager", fields: [masterManagerId], references: [id], onDelete: Cascade)

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // relations
  members     TeamMember[]
  reporting   TeamReporting[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TeamMember {
  id      String @id @default(uuid())
  teamId  String
  staffId String

  team  Team  @relation(fields: [teamId], references: [id], onDelete: Cascade)
  staff Staff @relation("TeamMemberStaff", fields: [staffId], references: [id], onDelete: Cascade)

  
  // A member can have multiple reportings
  reportings TeamReporting[] @relation("MemberToReporting")

  // ensure a person can only be once in a team
  @@unique([teamId, staffId])
}


model TeamReporting {
  id        String @id @default(uuid())
  teamId    String
  staffId   String        // person who reports
  managerId String        // person they report to, inside team

    // The link that enables cascade
  teamMemberId String?
  teamMember   TeamMember? @relation("MemberToReporting", fields: [teamMemberId], references: [id], onDelete: Cascade)

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  
  staff   Staff @relation("Reportee", fields: [staffId], references: [id], onDelete: Cascade)
  manager Staff @relation("Manager",  fields: [managerId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}


model Plan {
  id          String   @id @default(uuid())
  code        String   @unique // FREE, PRO, ENTERPRISE
  name        String
  billingCycle BillingCycle 
  price       Int
  isActive    Boolean @default(true)
  description String?

  features    PlanFeature[]
  subscriptions Subscription[]

  createdAt   DateTime @default(now())
}


enum BillingCycle {
  YEARLY
  MONTHLY
  WEEKLY
}

model PlanFeature {
  id        String @id @default(uuid())
  planId   String
  feature  FeatureCode
  limit    Int?   // null = unlimited, 0 = disabled

  plan Plan @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@unique([planId, feature])
}

enum FeatureCode {
 VMS_ACCESS
 STAFF_MANAGEMENT_ACCESS
}

model Subscription {
  id        String   @id @default(uuid())
  orgId     String   @unique
  planId    String

  status    SubscriptionStatus @default(ACTIVE)
  paidAmount  Int?
  startsAt  DateTime
  endsAt    DateTime
  trialEndsAt DateTime?

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  plan Plan @relation(fields: [planId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  EXPIRED
  CANCELED
}

model FeatureUsage {
  id          String @id @default(uuid())
  orgId       String
  feature     FeatureCode
  used        Int
  periodStart DateTime
  periodEnd   DateTime
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  @@unique([orgId, feature, periodStart])
}

model Notification {
  id        String   @id @default(uuid())
  orgId     String
  staffId   String
  visitId   String

  type      NotificationType
  title     String
  message   String

  isRead    Boolean  @default(false)
  action    NotificationAction @default(PENDING)

  createdAt DateTime @default(now())

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  staff        Staff        @relation(fields: [staffId], references: [id], onDelete: Cascade)
  visit        Visit        @relation(fields: [visitId], references: [id], onDelete: Cascade)

  @@index([staffId, isRead])
}

enum NotificationType {
  VISIT_REQUEST
  SYSTEM
  REMINDER
}

enum NotificationAction {
  PENDING
  ACCEPTED
  REJECTED
}
