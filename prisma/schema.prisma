generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id String @id @default(uuid())
  logo String?
  name  String
  email String @unique
  address String
  contactNumber String
  contactPerson String
  gst String?
  accountLimit  Int @default(5)
  settingCodeEncrypted String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  visits Visit[]
  staff Staff[]
  authCredentials UserCredential[]
  systemCredentials SystemCredential[]
  departments Department[]
  reasonOfVisits  ReasonOfVisit[]
   attendanceSessions AttendanceSession[]
  attendanceEvents AttendanceEvent[]

}

model Visit {
  id  String @id @default(uuid())
  orgId   String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  fullName  String
  visitorOrganization  String
  email  String
  reasonId  String?
  reasonOfVisit ReasonOfVisit? @relation(fields: [reasonId], references: [id])
  staffId String
  staff Staff @relation(fields: [staffId], references: [id], onDelete: Restrict)
  startTime DateTime @default(now())
  endTime DateTime?
  status  MeetingStatus @default(ONGOING)
  checkInPicture  String? 
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt  
}

model Staff {
  id String @id @default(uuid())
  orgId String
  organization  Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  userId String?  @unique
  userCredential UserCredential? @relation("StaffAuth", fields: [userId], references: [id], onDelete: Cascade)
  name  String  
  email String  @unique
  designation String 
  departmentId  String?  
  department  Department?  @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  role MemberRoleEnum @default(Staff)

  employeeCode String? @unique // used in QR / manual entry
  badgeActive  Boolean @default(true)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  visits Visit[]
  attendanceSessions AttendanceSession[]
  attendanceEvents AttendanceEvent[]
}

model AttendanceSession {
  id       String   @id @default(uuid())
  orgId    String
  staffId  String
  //usually startOfDay of first punch-in
  date     DateTime
  status       AttendanceSessionStatus @default(OPEN)
  closureType  AttendanceClosureType?
  isLateClosure          Boolean   @default(false)
  latePunchOutReason     String?
  latePunchOutRecordedAt DateTime?
  firstPunchInAt   DateTime?
  lastPunchOutAt   DateTime?
  totalWorkSeconds  Int @default(0)
  totalBreakSeconds Int @default(0)
  events   AttendanceEvent[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  staff        Staff        @relation(fields: [staffId], references: [id], onDelete: Cascade)
}

model AttendanceEvent {
  id      String  @id @default(uuid())
  orgId   String
  staffId String
  sessionId String?
  eventType AttendanceEventType
  source    AttendanceEventSource @default(QR)
  timestamp DateTime @default(now())
  // for corrections / late punches
  isCorrection   Boolean @default(false)
  correctionNote String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  staff        Staff        @relation(fields: [staffId], references: [id], onDelete: Restrict)
  session      AttendanceSession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)
}

enum AttendanceEventType {
  PUNCH_IN
  PUNCH_OUT
  BREAK_START
  BREAK_END
  LATE_PUNCH_OUT
}

enum AttendanceSessionStatus {
  OPEN
  CLOSED
}

enum AttendanceClosureType {
  NORMAL
  LATE
}

enum AttendanceEventSource {
  QR
  EMPLOYEE_ID
}


model RefreshToken {
  id  String @id @default(uuid())
  token String @unique
  userId  String?
  userCredentials UserCredential? @relation(fields: [userId], references: [id], onDelete: Cascade)
  systemId  String?
  systemCredentials SystemCredential? @relation(fields: [systemId], references: [id], onDelete: Cascade)
  expiryDate  DateTime
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}


model UserCredential{
  id String @id @default(uuid())
  orgId String?
  organization  Organization? @relation(fields: [orgId],references: [id], onDelete: Cascade)
  email String @unique
  password  String
  role AuthRoleEnum
  firstTimeLogin  Boolean? @default(true)
  accountStatus   AccountStatusEnum @default(Active) 
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  staff    Staff?  @relation("StaffAuth")
  refreshToken RefreshToken[]
  resetToken  ResetToken[]
}

model SystemCredential {
  id String @id @default(uuid())
  orgId String
  organization  Organization @relation(fields: [orgId],references: [id], onDelete: Cascade)
  email String @unique
  password  String
  secretCode  String?
  activityStatus  LoginStatus @default(LoggedOut)
  sessionId String?
  role String @default("System")
  refreshToken  RefreshToken[]
  resetTokenSystem  ResetTokenSystem[]
}

model Department {
  id  String  @id @default(uuid())
  orgId String
  organization  Organization  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  name  String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  staffs Staff[]
}

model ReasonOfVisit {
  id  String  @id @default(uuid())
  orgId String
  organization  Organization  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  name  String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  vists Visit[]
}

model ResetToken {
  id String @id @default(uuid())
  token String @unique
  userId  String @unique
  userCredential  UserCredential  @relation(fields: [userId],  references: [id], onDelete: Cascade)
  
}

model ResetTokenSystem {
    id String @id @default(uuid())
  token String @unique
  systemId String @unique
  systemCredential SystemCredential @relation(fields: [systemId], references: [id], onDelete: Cascade)
}


enum MeetingStatus {
  ONGOING
  COMPLETED
}

enum AuthRoleEnum {
  Root
  SuperAdmin
  Admin
  Staff
}

enum MemberRoleEnum {
  SuperAdmin
  Admin
  Staff
}

enum AccountStatusEnum {
  Active
  Disabled
}

enum LoginStatus {
  LoggedIn
  LoggedOut
}