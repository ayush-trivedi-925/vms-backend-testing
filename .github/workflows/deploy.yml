name: ğŸš€ Full VMS Deployment (Frontend + Backend)

on:
  push:
    branches:
      - master

concurrency:
  group: vms-production
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: [self-hosted, Linux, X64]

    steps:
      # ------------------------------------------------------------
      # 1ï¸âƒ£ Checkout Code
      # ------------------------------------------------------------
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: master

      # ------------------------------------------------------------
      # 2ï¸âƒ£ Pre-deploy sanity checks
      # ------------------------------------------------------------
      - name: ğŸ©º Pre-deploy sanity checks
        run: |
          set -e
          echo "ğŸ” Checking Docker daemon..."
          docker info > /dev/null

          echo "ğŸ’¾ Disk usage:"
          df -h

          echo "ğŸ§  Memory usage:"
          free -m

          echo "ğŸ“¦ Running containers:"
          docker ps

          echo "âœ… Pre-deploy checks passed"

      # ------------------------------------------------------------
      # 3ï¸âƒ£ Build Backend Image (Scan Only)
      # ------------------------------------------------------------
      - name: ğŸ³ Build Backend Image (Scan Only)
        run: |
          set -e
          DOCKER_BUILDKIT=1 docker build -t vms-backend-scan:latest /home/ubuntu/vms

      # ------------------------------------------------------------
      # 4ï¸âƒ£ Trivy Security Scan (Safe Mode First)
      # ------------------------------------------------------------
      - name: ğŸ” Scan Docker Image with Trivy
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: 'vms-backend-scan:latest'
          format: 'table'
          exit-code: '0'              # ğŸ”´ Change to '1' after 3-5 clean runs
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true

      # ------------------------------------------------------------
      # 5ï¸âƒ£ Deploy to Production
      # ------------------------------------------------------------
      - name: ğŸš€ Run Deployment Script
        env:
          HOME: /home/ubuntu
        run: |
          set -e
          set -o pipefail

          echo "==============================="
          echo "ğŸš€ VMS Production Deployment"
          echo "ğŸ•’ $(date)"
          echo "==============================="

          git rev-parse --abbrev-ref HEAD

          bash /home/ubuntu/vms/deploy.sh

          echo "âœ… Deployment completed successfully"

      # ------------------------------------------------------------
      # 6ï¸âƒ£ Cleanup Unused Images (Prevent Disk Issues)
      # ------------------------------------------------------------
      - name: ğŸ§¹ Cleanup Unused Docker Images
        run: |
          docker image prune -af || true
